<div class="row">
    <div class="col-md-12">
        <h1 class="admin-heading"><i class="fa fa-comments"></i> Comments Management</h1>
    </div>
    <div class="col-md-12">
        <div id="mytable"></div>
    </div>
</div>
<div class="modal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Modal title</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Modal body text goes here.</p>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
<script>
    const comments = <%- JSON.stringify(comments) %>;
    document.addEventListener("DOMContentLoaded", () => {
        new Tabulator("#mytable", {
            data: comments,
            layout: "fitColumns",
            pagination:true,
            paginationSize:10,
            paginationSizeSelector:[2,5,10,15],
            downloadRowRange: "visible",
            placeholder:"No Data Set",
            columns:[
                {title:"S.No.", formatter:"rownum", width:50, hozAlign:"center"},
                {title:"News", field:"news.content", headerFilter:"input",
                    formatter: function (cell) {
                        const value = cell.getValue();
                        return value
                        ? value
                        : "";
                    }
                },
                {title:"Name", field:"name", headerFilter:"input"},
                {title:"Comment", field:"content", headerFilter:"input"},
                {title:"Status", field:"status", headerFilter:"input"},
                {title: "Date", field: "createdAt",
                    headerFilter: "input",
                    formatter: function (cell) {
                        const value = cell.getValue();
                        return value
                        ? new Date(value).toLocaleString()
                        : "";
                    }
                },
                {title:"Action", formatter:function(cell, formatterParams, onRendered){
                    return `<a href="javascript:void(0)" onclick="onUpdate('${cell.getData()._id}')" class="btn btn-info btn-sm"><i class="fa fa-edit">Update</i></a>
                            <a href="javascript:void(0)" onclick="onDelete('${cell.getData()._id}')" class="btn btn-outline-danger btn-sm"><i class="fa fa-trash-o"></i>Delete</a>`;
                }},
                
            ],
        });
    });

    async function onDelete(id){
        if(confirm('Are you sure?')){
            const response = await fetch(`/admin/comment/delete/${id}`, {
                method: 'DELETE'
            })
            if(response.ok){
                window.location.reload();
            }
        }
    }

    // Using bootstrap modal to show and update comments
    async function onUpdate(id){
        const comment = comments.find(comment => comment._id === id);

        document.querySelector('.modal-title').innerHTML = "Update Comment";
        
        document.querySelector('.modal-body').innerHTML = `
            <form id="updateCommentForm">
                <div class="mb-3">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-control" value="${comment.name}" disabled>
                </div>

                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" value="${comment.email}" disabled>
                </div>

                <div class="mb-3">
                    <label class="form-label">Comment</label>
                    <textarea class="form-control" rows="3" disabled>${comment.content}</textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">Status</label>
                    <select class="form-control" name="status">
                        <option value="pending" ${comment.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="approved" ${comment.status === 'approved' ? 'selected' : ''}>Approved</option>
                        <option value="rejected" ${comment.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary float-end">Update Comment</button>
            </form>`;

            document.getElementById('updateCommentForm')
                .addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const formData = new FormData(this);

                    const res = await fetch(`/admin/comment/update/${id}`, {
                        method: 'POST',
                        body: new URLSearchParams(formData)
                    });

                    const data = await res.json();

                    if (data.msg === true) {
                        // ✅ Close modal
                        const modalEl = document.querySelector('.modal');
                        const modal = bootstrap.Modal.getInstance(modalEl);
                        modal.hide();

                        // ✅ Option 1: Refresh page
                        location.reload();

                        // ✅ Option 2 (better): Update UI without reload
                        // updateCommentStatusInDOM(id, formData.get('status'));
                    }
                });
        
        const modal = new bootstrap.Modal(document.querySelector('.modal'));
        modal.show();
    }

    
</script>

<%- contentFor('tabulatorCss') %>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<link href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator.min.css" rel="stylesheet">